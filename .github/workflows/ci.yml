name: Java CI Pipeline (Build & Test - Maven)

# Dispara o workflow nos eventos de push e pull request para a branch 'main'
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # JOB 1: Integra√ß√£o Cont√≠nua (Build, Testes Unit√°rios e SAST)
  build-and-test:
    runs-on: ubuntu-latest
    env:
      # Padroniza a codifica√ß√£o para evitar falhas de string em testes E2E
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8

    steps:
      - name: Checkout Code üõéÔ∏è
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      # Configura√ß√£o manual do Display Virtual (Necess√°rio para o Selenium E2E)
      - name: Setup Virtual Display (Manual Xvfb) üñ•Ô∏è
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          Xvfb :99 -ac -screen 0 1280x1024x24 &
          echo "DISPLAY=:99" >> $GITHUB_ENV

      # Execu√ß√£o do Build, Testes Unit√°rios e SAST
      - name: Run Maven Build, Tests, and SAST
        run: mvn clean verify org.owasp:dependency-check-maven:check -DskipTests=false
        env:
          DISPLAY: :99

      # Upload do Artefato JAR (Necess√°rio para o job de Deploy)
      - name: Upload JAR Artifact üì¶
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: target/*.jar

  # JOB 2: Deploy Cont√≠nuo (CD) e Valida√ß√£o P√≥s-Deploy
  deploy-to-test:
    # S√≥ roda se o job de build for bem-sucedido
    needs: build-and-test
    runs-on: ubuntu-latest

    # Configura√ß√£o de Ambiente
    environment:
      name: test
      url: http://localhost:7000/funcionarios # URL de valida√ß√£o para o teste p√≥s-deploy

    steps:
      # 1. Download do Artefato JAR
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: application-jar
          path: target/deployment-dir

      # 2. Inicia o Servidor (Deploy Simulado)
      - name: Start Javalin Server for Post-Deploy Test üöÄ
        run: |
          echo "Simulando deploy no ambiente TESTE..."
          # Encontra o JAR e o executa em background
          cd target/deployment-dir
          JAR_FILE=$(find . -name "*.jar")
          nohup java -jar $JAR_FILE > server.log 2>&1 &
          
          echo "Aguardando 10 segundos para o servidor subir..."
          sleep 10s 

      # 3. CRUCIAL: Clonar o c√≥digo novamente para acessar a classe de teste E2E
      - name: Checkout Code for Post-Deploy Test
        uses: actions/checkout@v4
        with:
          path: checkout-for-test

      # 4. Configura√ß√£o do Java e M√≥dulos para o Runner de Teste
      - name: Setup Java for Test Runner
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # 5. Execu√ß√£o dos Testes P√≥s-Deploy contra o servidor ativo
      - name: Run Selenium Post-Deploy Tests üß™
        run: |
          cd checkout-for-test
          mvn test -Dtest=br.com.infnet.tests.FuncionarioWebTest
        env:
          DISPLAY: :99 # Necess√°rio para o Selenium no runner
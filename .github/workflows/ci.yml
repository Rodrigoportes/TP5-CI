name: Java CI Pipeline (Build & Test - Maven)

# Dispara o workflow nos eventos de push e pull request para a branch 'main'
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  # JOB 1: CI (Build, Testes, SAST)
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code üõéÔ∏è
        uses: actions/checkout@v4

      # Configura√ß√£o do Java 21
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'

      # Configura√ß√£o manual do Display Virtual (Corre√ß√£o de Xvfb)
      - name: Setup Virtual Display (Manual Xvfb) üñ•Ô∏è
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb
          Xvfb :99 -ac -screen 0 1280x1024x24 &
          echo "DISPLAY=:99" >> $GITHUB_ENV

      # Execu√ß√£o do Build, Testes e SAST
      - name: Run Maven Build, Tests, and SAST
        run: mvn clean verify org.owasp:dependency-check-maven:check -DskipTests=false
        env:
          DISPLAY: :99

      # Upload do Artefato (JAR) para o Job de Deploy
      - name: Upload JAR Artifact üì¶
        uses: actions/upload-artifact@v4
        with:
          name: application-jar
          path: target/*.jar

  # JOB 2: CD (Deploy Cont√≠nuo)
  deploy-to-test:
    # 1. Depend√™ncia: S√≥ roda se o 'build-and-test' passar
    needs: build-and-test
    runs-on: ubuntu-latest

    # 2. Configura√ß√£o de Ambiente
    environment:
      name: test
      url: https://seuateste.com/funcionarios # URL de exemplo

    steps:
      # Download do JAR
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: application-jar # Referencia o artefato salvo no job anterior
          path: target/deployment-dir # Baixa para uma pasta para organizar

      # CRUCIAL: Implementa√ß√£o do Deploy (Simula√ß√£o)
      - name: Deploy to Test Environment üöÄ
        run: |
          echo "Simulando deploy no ambiente TESTE..."
          # L√≥gica de deploy (e-mail, chamada a provedor cloud, etc.)
          echo "Deploy do artefato conclu√≠do para o ambiente de teste."

      # [PASSO FUTURO]: Aqui entraria a valida√ß√£o p√≥s-deploy com Selenium!